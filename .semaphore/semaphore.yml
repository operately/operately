version: v1.0
name: Operately â€” Build & Test
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004
blocks:
  - name: Tests
    dependencies: []
    task:
      prologue:
        commands:
          - checkout
          - cache restore
          - cd assets && cache restore && cd .. # cache node_packages
          - cp docker-compose.yml.ci docker-compose.yml # use a minimal docker compose for tests on CI
      epilogue:
        always:
          commands:
            - test-results publish testreports/junit.xml
      jobs:
        - name: mix test
          commands:
            - make test.seed.env
            - make test.setup
            - make test
            - cache store
            - cd assets && cache store && cd .. # cache node_packages

  - name: Docker Build
    dependencies: []
    run:
      when: "branch = 'main'"
    task:
      secrets:
        - name: docker-push
      prologue:
        commands:
          - checkout
          - cache restore
      jobs:
        - name: "Docker Release"
          commands:
            - docker pull operately/operately:latest
            - make docker.build
            - make docker.push

  - name: License Check
    dependencies: []
    task:
      jobs:
        - name: "Check"
          commands:
            - checkout
            - curl -L https://github.com/pivotal/LicenseFinder/blob/v7.1.0/dlf > /tmp/dlf
            - chmod +x /tmp/dlf
            - sudo mv /tmp/dlf /usr/local/bin/dlf
            - dlf

promotions:
  - name: Staging 1
    pipeline_file: staging1.yml
    auto_promote:
      when: "result = 'passed' and branch = 'main'"
