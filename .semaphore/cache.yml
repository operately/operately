version: v1.0
name: Populate CI Cache
agent:
  machine:
    type: f1-standard-4
    os_image: ubuntu2004

blocks:
  - name: Populate CI Cache
    task:
      secrets:
        - name: ci-cache-credentials
      prologue:
        commands:
          - checkout
          - chmod 600 /home/semaphore/.ssh/cache_key
      jobs:
        - name: "Populate CI Cache"
          commands:
            - make test.build
            # Cache Docker images
            - ./scripts/ci-cache.sh save-docker-image operately-app:latest docker/operately-app.tar.gz
            # Cache dependencies
            - ./scripts/ci-cache.sh push app/deps deps
            - ./scripts/ci-cache.sh push app/_build build
            - ./scripts/ci-cache.sh push app/assets/node_modules app/assets/node_modules
