version: v1.0
name: Populate CI Cache
agent:
  machine:
    type: f1-standard-4
    os_image: ubuntu2004

blocks:
  - name: Populate CI Cache
    task:
      secrets:
        - name: ci-cache-credentials
      jobs:
        - name: "Populate CI Cache"
          commands:
            - checkout
            - make test.build
            - ./scripts/ci-cache.sh push app/deps app/deps
            - ./scripts/ci-cache.sh push app/_build app/build
            - ./scripts/ci-cache.sh push app/node_modules app/node_modules
            - ./scripts/ci-cache.sh save-docker-image operately-app:latest docker/operately-app.tar.gz
