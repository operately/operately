## Description Change Notifications Specification

### Feature Overview
- Enable milestone, goal, and project description activities to carry the rich-text body so we can reuse mention detection, feed summaries, and emails identical to task description updates.
- Dispatch notifications and emails only to people mentioned in the updated description, always omitting the author, and rely on `Operately.RichContent.find_mentioned_ids/2` for mention parsing.
- Roll the work out in four stages: Milestone description notifications → Goal description notifications → Project description activity plumbing → Project description notifications.
- Preserve the existing `has_description` convention (true when the description contains content, false when it is empty) so the UI continues to behave consistently.
- Maintain parity across Elixir (activity content, serializers, notification dispatchers), front-end feed handlers, and feature coverage so that behaviour matches the existing task flow.

### Stage 1 – Milestone Description Notifications
- Step 1 — Expand `app/lib/operately/activities/content/milestone_description_updating.ex` with a `:description` map field (plus updated validations) so the activity stores the same payload structure as `Operately.Tasks.Task` and keep `has_description` in sync with `Operately.RichContent.empty?/1`.
- Step 2 — Update `app/lib/operately_web/api/project_milestones.ex` when building the `:milestone_description_updating` activity to include the rich description payload; mirror that data in `app/lib/operately_web/api/serializers/activity_content/milestone_description_updating.ex`, extend `app/lib/operately_web/api/types.ex` (including the `:activity_content` union), run `make gen`, and refresh `app/assets/js/features/activities/MilestoneDescriptionUpdating/index.tsx` to render a `Summary` with mention lookups and fallbacks for legacy activities.
- Step 3 — Replace the stub in `app/lib/operately/activities/notifications/milestone_description_updating.ex` with mention-based dispatch logic that filters out the author and gracefully skips nil/legacy descriptions before calling `Operately.Notifications.bulk_create/1`.
- Step 4 — Introduce `OperatelyEmail.Emails.MilestoneDescriptionUpdatingEmail` plus matching HTML/text templates under `app/lib/operately_email/templates/`, decode JSON-or-map descriptions like the task email does, and ensure the subject references the project and milestone.
- Step 5 — Add a feature scenario to `app/test/features/project_milestones_test.exs` that edits a milestone description with a mention and asserts notification and email delivery; extend `app/test/support/features/project_milestones_steps.ex`, `EmailSteps`, and `NotificationsSteps` with helpers for mentioning people in milestone descriptions and validating the new messages.

### Stage 2 – Goal Description Notifications
- Step 1 — Extend `app/lib/operately/activities/content/goal_description_changed.ex` to keep `:old_description` and `:new_description`, add a `:has_description` flag that follows the existing truthiness convention, and tighten validations so `:new_description` always carries the rich text needed downstream.
- Step 2 — Update `app/lib/operately_web/api/goals.ex` (`UpdateDescription` mutation) to capture the rich description, compute `has_description`, and persist the enhanced content; add a serializer in `app/lib/operately_web/api/serializers/activity_content/goal_description_changed.ex`, wire the type in `app/lib/operately_web/api/types.ex`, run `make gen`, and create a new handler under `app/assets/js/features/activities/GoalDescriptionChanged` that mirrors the task feed summary and registers in `DISPLAYED_IN_FEED` and the `ts-pattern` matcher.
- Step 3 — Implement `Operately.Activities.Notifications.GoalDescriptionChanged.dispatch/1` so it uses `Operately.RichContent.find_mentioned_ids/2`, de-duplicates recipients, filters the author, and calls `Operately.Notifications.bulk_create/1` with `should_send_email: true`.
- Step 4 — Deliver a new email pipeline (`OperatelyEmail.Emails.GoalDescriptionChangedEmail` plus templates) that mirrors the task email flow: preload goal/project context, decode the description body, and craft the subject/action strings used by `EmailSteps`.
- Step 5 — Cover the flow with a feature spec (e.g. in `app/test/features/goal_test.exs`) that edits a goal description with a mention and asserts both notification and email delivery; add the supporting helpers to `app/test/support/features/goal_steps.ex`, `EmailSteps`, and `NotificationsSteps`.

### Stage 3 – Project Description Activity
- Step 1 — Create `app/lib/operately/activities/content/project_description_changed.ex` with the same shape as the task/milestone versions (company, space, project, project name, `has_description`, `description`) and validations that require the rich-text payload.
- Step 2 — Update `app/lib/operately_web/api/mutations/update_project_description.ex` to decode the incoming JSON once, build an `Ecto.Multi` inline in the module that updates the project description and inserts a `:project_description_changed` activity (author is the mutation actor) with the project metadata, `has_description`, and stored description, then finish by serializing the updated project.
- Step 3 — Add a serializer at `app/lib/operately_web/api/serializers/activity_content/project_description_changed.ex`, register a new object and union arm in `app/lib/operately_web/api/types.ex`, run `make gen`, and confirm the generated TypeScript exposes `ActivityContentProjectDescriptionChanged`.
- Step 4 — Register the action anywhere activities are enumerated: append `"project_description_changed"` to the project-action lists in `app/lib/operately/activities/context_auto_assigner.ex` and `app/lib/operately/data/change_013_create_activities_access_context.ex`, and include the new module wherever activity content modules are referenced so context assignment continues to work.
- Step 5 — Build a front-end handler in `app/assets/js/features/activities/ProjectDescriptionChanged` that renders a feed title and `Summary` body, implement notification copy methods, and register it with `DISPLAYED_IN_FEED` plus the matcher in `app/assets/js/features/activities/index.tsx`.
- Step 6 — Extend `app/test/features/project_description_test.exs` (and supporting steps in `app/test/support/features/projects_steps.ex`) to assert that editing the project description now produces a feed item showing the truncated description and that legacy behaviour still works.

### Stage 4 – Project Description Notifications
- Step 1 — Implement `Operately.Activities.Notifications.ProjectDescriptionChanged` using the same mention-only strategy and author exclusion as the milestone/goal/task modules, handling map-or-JSON descriptions safely.
- Step 2 — Add `OperatelyEmail.Emails.ProjectDescriptionChangedEmail` with new HTML/text templates that mirror the task email subject structure (`where: project.name`, `action: "updated the project description"`), decoding the description for template rendering.
- Step 3 — Enhance the `ProjectDescriptionChanged` handler to surface `NotificationTitle`/`NotificationLocation` strings that match the assertions we’ll add to the tests and ensure the feed content uses the decoded description with mention lookups.
- Step 4 — Write a feature scenario in `app/test/features/project_description_test.exs` that mentions a teammate in the project description, then asserts notification and email delivery while confirming the author is not notified; extend `ProjectsSteps`, `EmailSteps`, and `NotificationsSteps` with the necessary helpers.
- Step 5 — Run the targeted suites (`make test.mix.features FILE=app/test/features/project_milestones_test.exs`, `make test.mix.features FILE=app/test/features/goal_test.exs`, `make test.mix.features FILE=app/test/features/project_description_test.exs`) plus regenerate types after each stage, watching for flaky legacy activities that may lack descriptions and guarding for them in the new handlers.

### QA & Rollout
- Validate that mention parsing works with both freshly saved descriptions and legacy records (where `description` may still be missing) and ensure we skip notification creation gracefully in those cases.
- Double-check email previews for all three activities to confirm rich text is rendered and links point to the correct Project/Goal/Milestone pages.
- Smoke-test feeds (project, space, company) to verify the new summary cards appear in the right sections and that pagination still works with the new content types.
- Coordinate deployment of each stage separately, merging after the focused test suite passes and re-running `make gen` before committing to keep generated files aligned.
